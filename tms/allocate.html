<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Room Allocation</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700;800&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #dbeafe;
      --secondary: #10b981;
      --secondary-dark: #059669;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #1e293b;
      --gray: #64748b;
      --light-gray: #e2e8f0;
      --white: #ffffff;
      --body-bg: #f8fafc;
      --card-bg: #ffffff;
      --border-radius: 0.5rem;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --font-family: 'Poppins', sans-serif;
      --font-family-heading: 'Montserrat', sans-serif;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--body-bg);
      color: var(--dark);
      min-height: 100vh;
      line-height: 1.6;
      padding-bottom: 70px;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: var(--white);
      box-shadow: var(--shadow);
      z-index: 100;
      height: 70px;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100%;
      padding: 0 1rem;
      max-width: 1700px;
      margin: 0 auto;
    }

    .logo {
      font-family: var(--font-family-heading);
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      outline: none;
      text-decoration: none;
    }

    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
    }

    .btn-icon {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    .allocation-container {
      max-width: 1200px;
      margin: 100px auto 2rem;
      padding: 0 1rem;
    }

    /* Room Grid Styling */
    .room-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .room-box {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      border: 1px solid var(--light-gray);
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .room-box:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .room-box.selected {
      border: 2px solid var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
    }

    .room-box.vacant {
      background: linear-gradient(135deg, var(--secondary) 0%, rgba(16, 185, 129, 0.7) 100%);
    }

    .room-box.partial {
      background: linear-gradient(135deg, var(--warning) 0%, rgba(245, 158, 11, 0.7) 100%);
    }

    .room-box.occupied {
      background: linear-gradient(135deg, var(--danger) 0%, rgba(239, 68, 68, 0.7) 100%);
    }

    .room-number {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }

    .room-status {
      font-size: 0.8rem;
      font-weight: 600;
      color: white;
      padding: 3px 6px;
      border-radius: 4px;
      display: inline-block;
    }

    .occupancy-icon {
      margin-top: 0.5rem;
      font-size: 1.5rem;
    }

    .floor-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 1.5rem 0 0.5rem;
      color: var(--gray);
      border-bottom: 1px solid var(--light-gray);
      padding-bottom: 0.5rem;
    }

    form {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      border: 1px solid var(--light-gray);
      box-shadow: var(--shadow);
      padding: 2rem;
      margin-top: 2rem;
      scroll-margin-top: 100px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--gray);
      font-size: 0.9rem;
    }

    input,
    select,
    button {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--light-gray);
      border-radius: var(--border-radius);
      background: var(--white);
      color: var(--dark);
      font-size: 1rem;
      transition: var(--transition);
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
    }

    button {
      background: var(--primary);
      color: var(--white);
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }

    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: var(--white);
      box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      z-index: 100;
    }

    .nav-button {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      text-decoration: none;
      padding: 8px 0;
      border-radius: 0;
      transition: var(--transition);
      color: var(--gray);
      font-size: 0.75rem;
    }

    .nav-button svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .bottom-nav .nav-button:hover {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary);
    }

    .nav-button.active {
      color: var(--primary);
      font-weight: 600;
    }

    /* Popup Container */
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      display: none;
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    /* Popup Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 999;
      display: none;
    }

    /* Popup Content */
    .popup p {
      font-size: 1.1rem;
      margin-bottom: 25px;
    }

    /* Popup Button */
    .popup button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 22px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      transition: var(--transition);
    }

    .popup button:hover {
      background: var(--primary-dark);
    }

    /* Vacant Button */
    .vacant-button {
      background: var(--danger);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      margin-top: 1rem;
    }

    .vacant-button:hover {
      background: #e63e3e;
      transform: translateY(-2px);
    }

    /* Section Title */
    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 2rem 0 1rem;
      color: var(--dark);
    }

    /* Form Section */
    .form-section {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--light-gray);
    }

    .form-section:last-child {
      border-bottom: none;
    }

    /* Highlight effect for form when scrolled to */
    @keyframes highlight-form {
      0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
      100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
    }

    .highlight-form {
      animation: highlight-form 1s ease-out;
    }

    /* Button Group */
    .button-group {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 1rem;
    }

    .update-button {
      background: var(--secondary);
      color: white;
    }

    .update-button:hover {
      background: var(--secondary-dark);
    }

    .allocate-button {
      background: var(--primary);
      color: white;
    }

    .allocate-button:hover {
      background: var(--primary-dark);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .room-grid {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .header-container {
        padding: 0 0.5rem;
      }

      .header {
        height: 60px;
      }

      .allocation-container {
        margin-top: 80px;
      }
      
      .button-group {
        grid-template-columns: 1fr;
      }
    }

    /* Tenant section styling */
    .tenant-container {
      border: 1px solid var(--light-gray);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
      background-color: var(--white);
      box-shadow: var(--shadow-sm);
    }

    .tenant-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--light-gray);
    }

    .tenant-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-container">
      <a href="/" class="logo">
        mytenants.online
      </a>
      <div class="header-actions">
        <button id="exportBtn" class="btn btn-primary">
          <svg class="btn-icon" viewBox="0 0 24 24">
            <path d="M14,2H6C4.89,2 4,2.89 4,4V20C4,21.11 4.89,22 6,22H18C19.11,22 20,21.11 20,20V8L14,2M18,20H6V4H13V9H18V20M10,19L12,15H9V10H15V15H12L14,19H10Z" />
          </svg>
          Export to CSV
        </button>
      </div>
    </div>
  </header>

  <div class="allocation-container">
    <!-- Room Selection Grid -->
    <h2 class="section-title">Select a Room</h2>
    <div id="roomGridContainer"></div>

    <!-- Form with ID for scrolling target -->
    <form id="allocationForm">
      <input type="hidden" id="selectedRoom" value="">
      <input type="hidden" id="currentAction" value="allocate">
      
      <!-- Tenant 1 Container -->
      <div id="tenant1Container" class="tenant-container">
        <div class="tenant-header">
          <h3 class="tenant-title">Tenant 1</h3>
        </div>
        
        <!-- Tenant 1 Basic Details Section -->
        <div class="form-section">
          <h3 class="section-title">Basic Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="moveInDate1">Move-In Date</label>
              <input type="date" id="moveInDate1" required>
            </div>
            <div class="form-group">
              <label for="rentStatus1">Rent Status</label>
              <select id="rentStatus1" required>
                <option value="Pending">Pending</option>
                <option value="Unpaid">Unpaid</option>
                <option value="Paid">Paid</option>
              </select>
            </div>
            <div class="form-group">
              <label for="lastPaidDate1">Last Paid Date</label>
              <input type="date" id="lastPaidDate1" required>
            </div>
          </div>
        </div>

        <!-- Tenant 1 Financial Details Section -->
        <div class="form-section">
          <h3 class="section-title">Financial Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="rentAmount1">Rent Amount</label>
              <input type="number" id="rentAmount1" placeholder="Enter amount" required>
            </div>
            <div class="form-group">
              <label for="foodCharges1">Food Charges</label>
              <input type="number" id="foodCharges1" placeholder="Enter food charges">
            </div>
            <div class="form-group">
              <label for="electricityCharges1">Electricity Charges</label>
              <input type="number" id="electricityCharges1" placeholder="Enter electricity charges">
            </div>
          </div>
        </div>

        <!-- Tenant 1 Details Section -->
        <div class="form-section">
          <h3 class="section-title">Personal Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="tenantName1">Full Name</label>
              <input type="text" id="tenantName1" placeholder="Full name" required>
            </div>
            <div class="form-group">
              <label for="tenantGender1">Gender</label>
              <select id="tenantGender1" required>
                <option value="M">Male</option>
                <option value="F">Female</option>
              </select>
            </div>
            <div class="form-group">
              <label for="tenantContact1">Contact</label>
              <input type="text" id="tenantContact1" placeholder="Phone number" required>
            </div>
            <div class="form-group">
              <label for="tenantGovtId1">Government ID</label>
              <input type="text" id="tenantGovtId1" placeholder="Aadhaar/Voter ID/etc." required>
            </div>
          </div>
          
          <!-- Tenant 1 Action Buttons -->
          <div class="button-group">
            <button type="button" class="update-button" id="updateButton1">Update Tenant</button>
            <button type="button" class="allocate-button" id="allocateButton1">Allocate Room</button>
            <button type="button" class="vacant-button" id="vacantButton1">Vacant Room</button>
          </div>
        </div>
      </div>

      <!-- Tenant 2 Container -->
      <div id="tenant2Container" class="tenant-container">
        <div class="tenant-header">
          <h3 class="tenant-title">Tenant 2 (Optional)</h3>
        </div>
        
        <!-- Tenant 2 Basic Details Section -->
        <div class="form-section">
          <h3 class="section-title">Basic Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="moveInDate2">Move-In Date</label>
              <input type="date" id="moveInDate2">
            </div>
            <div class="form-group">
              <label for="rentStatus2">Rent Status</label>
              <select id="rentStatus2">
                <option value="Pending">Pending</option>
                <option value="Unpaid">Unpaid</option>
                <option value="Paid">Paid</option>
              </select>
            </div>
            <div class="form-group">
              <label for="lastPaidDate2">Last Paid Date</label>
              <input type="date" id="lastPaidDate2">
            </div>
          </div>
        </div>

        <!-- Tenant 2 Financial Details Section -->
        <div class="form-section">
          <h3 class="section-title">Financial Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="rentAmount2">Rent Amount</label>
              <input type="number" id="rentAmount2" placeholder="Enter amount">
            </div>
            <div class="form-group">
              <label for="foodCharges2">Food Charges</label>
              <input type="number" id="foodCharges2" placeholder="Enter food charges">
            </div>
            <div class="form-group">
              <label for="electricityCharges2">Electricity Charges</label>
              <input type="number" id="electricityCharges2" placeholder="Enter electricity charges">
            </div>
          </div>
        </div>

        <!-- Tenant 2 Details Section -->
        <div class="form-section">
          <h3 class="section-title">Personal Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="tenantName2">Full Name</label>
              <input type="text" id="tenantName2" placeholder="Full name">
            </div>
            <div class="form-group">
              <label for="tenantGender2">Gender</label>
              <select id="tenantGender2">
                <option value="M">Male</option>
                <option value="F">Female</option>
              </select>
            </div>
            <div class="form-group">
              <label for="tenantContact2">Contact</label>
              <input type="text" id="tenantContact2" placeholder="Phone number">
            </div>
            <div class="form-group">
              <label for="tenantGovtId2">Government ID</label>
              <input type="text" id="tenantGovtId2" placeholder="Aadhaar/Voter ID/etc.">
            </div>
          </div>
          
          <!-- Tenant 2 Action Buttons -->
          <div class="button-group">
            <button type="button" class="update-button" id="updateButton2">Update Tenant</button>
            <button type="button" class="allocate-button" id="allocateButton2">Allocate Room</button>
            <button type="button" class="vacant-button" id="vacantButton2">Vacant Room</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Popup for Success/Error Messages -->
  <div class="overlay" id="overlay"></div>
  <div class="popup" id="popup">
    <p id="popupMessage"></p>
    <button id="closePopup">OK</button>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a class='nav-button active' href='allocate.html'>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
      </svg>
      Allocate
    </a>
    <a class='nav-button' href='index.html'>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2L2 12h3v8h6v-6h2v6h6v-8h3L12 2z"/>
      </svg>
      Home
    </a>
    <a class='nav-button' href='rent.html'>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M11.8,10.9c-2.27-0.59-3-1.2-3-2.15c0-1.09,1.01-1.85,2.7-1.85c1.78,0,2.44,0.85,2.5,2.1h2.21c-0.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94,0.42-3.5,1.68-3.5,3.61c0,2.31,1.91,3.46,4.7,4.13c2.5,0.6,3,1.48,3,2.41c0,0.69-0.49,1.79-2.7,1.79c-2.06,0-2.87-0.92-2.98-2.1h-2.2c0.12,2.19,1.76,3.42,3.68,3.83V21h3v-2.15c1.95-0.37,3.5-1.5,3.5-3.55C16.5,12.46,14.07,11.49,11.8,10.9z"/>
      </svg>
      Rent
    </a>
  </nav>

  <script type="module">
    // Firebase Configuration
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getDatabase, ref, set, get, remove, onValue, update } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBEX5lj5VRhmlxAhHskQJVB1G6uoVEVvmQ",
      authDomain: "diamoundbhai.firebaseapp.com",
      projectId: "diamoundbhai",
      storageBucket: "diamoundbhai.firebasestorage.app",
      messagingSenderId: "236932120968",
      appId: "1:236932120968:web:a3d9ec830d48757024fa3d",
      measurementId: "G-MK06SH1QNL",
      databaseURL: "https://diamoundbhai-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Helper function to show popup messages
    function showPopup(message, type) {
      const popup = document.getElementById("popup");
      const overlay = document.getElementById("overlay");
      const popupMessage = document.getElementById("popupMessage");

      popupMessage.textContent = message;
      popup.className = `popup ${type}`;
      popup.style.display = "block";
      overlay.style.display = "block";

      // Auto-close the popup after 3 seconds
      setTimeout(() => {
        popup.style.display = "none";
        overlay.style.display = "none";
      }, 3000);
    }

    // Close popup when OK button is clicked
    document.getElementById("closePopup").addEventListener("click", function() {
      document.getElementById("popup").style.display = "none";
      document.getElementById("overlay").style.display = "none";
    });

    // Generate the room grid with visual representation
    function generateRoomGrid() {
      const roomGridContainer = document.getElementById("roomGridContainer");
      roomGridContainer.innerHTML = '';

      // Create rooms organized by floor
      for (let floor = 1; floor <= 6; floor++) {
        // Create floor section
        const floorSection = document.createElement("div");
        floorSection.className = "floor-section";
        floorSection.innerHTML = `<h3 class="floor-title">Floor ${floor}</h3>`;
        
        // Create room grid for this floor
        const floorGrid = document.createElement("div");
        floorGrid.className = "room-grid";
        
        // Add rooms to this floor
        for (let r = 1; r <= 10; r++) {
          const roomNumber = `${floor}${r < 10 ? '0' + r : r}`;
          
          // Create room box
          const roomBox = document.createElement("div");
          roomBox.className = "room-box vacant"; // Default to vacant
          roomBox.dataset.roomNumber = roomNumber;
          
          // Set initial content (will be updated with real data)
          roomBox.innerHTML = `
            <div class="room-number">${roomNumber}</div>
            <div class="occupancy-icon">👤0</div>
            <div class="room-status">Vacant</div>
          `;
          
          // Add click event to select room and scroll to form
          roomBox.addEventListener("click", function() {
            // Remove selected class from all rooms
            document.querySelectorAll(".room-box").forEach(box => {
              box.classList.remove("selected");
            });
            
            // Add selected class to this room
            this.classList.add("selected");
            
            // Set the selected room in the hidden input
            document.getElementById("selectedRoom").value = this.dataset.roomNumber;
            
            // Load room details
            loadRoomDetails(this.dataset.roomNumber);
            
            // Scroll to the form section with smooth behavior
            const form = document.getElementById("allocationForm");
            
            // Add highlight effect to the form
            form.classList.remove("highlight-form");
            // Trigger reflow to restart animation
            void form.offsetWidth;
            form.classList.add("highlight-form");
            
            // Scroll to the form
            form.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'start'
            });
            
            // Focus on the first input field after scrolling
            setTimeout(() => {
              document.getElementById("moveInDate1").focus();
            }, 800); // Delay to allow scroll to complete
          });
          
          floorGrid.appendChild(roomBox);
        }
        
        floorSection.appendChild(floorGrid);
        roomGridContainer.appendChild(floorSection);
      }

      // Update room status from Firebase
      updateRoomStatus();
    }

    // Update room status based on Firebase data
    function updateRoomStatus() {
      const roomsRef = ref(database, 'rooms');
      
      // Listen for changes in real-time
      onValue(roomsRef, (snapshot) => {
        const roomData = snapshot.exists() ? snapshot.val() : {};
        
        // Update all room boxes with current data
        document.querySelectorAll(".room-box").forEach(roomBox => {
          const roomNumber = roomBox.dataset.roomNumber;
          const roomInfo = roomData[roomNumber];
          
          if (roomInfo) {
            // Room is allocated
            const tenants = roomInfo.tenants || [];
            const occupancyCount = tenants.filter(t => t && t.trim() !== "").length;
            
            if (occupancyCount === 2) {
              // Fully occupied
              roomBox.className = "room-box occupied";
              roomBox.querySelector(".occupancy-icon").innerHTML = "👥2";
              roomBox.querySelector(".room-status").textContent = "Occupied";
            } else if (occupancyCount === 1) {
              // Partially occupied
              roomBox.className = "room-box partial";
              roomBox.querySelector(".occupancy-icon").innerHTML = "👤1";
              roomBox.querySelector(".room-status").textContent = "Partial";
            } else {
              // Should be vacant, but has data
              roomBox.className = "room-box vacant";
              roomBox.querySelector(".occupancy-icon").innerHTML = "👤0";
              roomBox.querySelector(".room-status").textContent = "Vacant";
            }
          } else {
            // Room is vacant
            roomBox.className = "room-box vacant";
            roomBox.querySelector(".occupancy-icon").innerHTML = "👤0";
            roomBox.querySelector(".room-status").textContent = "Vacant";
          }
        });
      });
    }

    // Load existing room details
    function loadRoomDetails(roomNumber) {
      const roomRef = ref(database, 'rooms/' + roomNumber);
      get(roomRef).then((snapshot) => {
        if (snapshot.exists()) {
          const roomData = snapshot.val();
          
          // Tenant 1 Basic details
          document.getElementById("moveInDate1").value = roomData.moveInDate1 || roomData.moveInDate || '';
          document.getElementById("rentStatus1").value = roomData.rentStatus1 || roomData.rentStatus || 'Pending';
          document.getElementById("lastPaidDate1").value = roomData.lastPaidDate1 || roomData.lastPaidDate || roomData.moveInDate || '';
          
          // Tenant 1 Financial details
          document.getElementById("rentAmount1").value = roomData.rentAmount1 || roomData.rentAmount || roomData.rent_due || '';
          document.getElementById("foodCharges1").value = roomData.foodCharges1 || roomData.foodCharges || '';
          document.getElementById("electricityCharges1").value = roomData.electricityCharges1 || roomData.electricityCharges || '';
          
          // Tenant 1 Personal details
          document.getElementById("tenantName1").value = roomData.tenants ? roomData.tenants[0] || '' : '';
          document.getElementById("tenantGender1").value = roomData.gender1 || roomData.gender || 'M';
          document.getElementById("tenantContact1").value = roomData.contactNumbers ? roomData.contactNumbers[0] || '' : '';
          document.getElementById("tenantGovtId1").value = roomData.govtIds ? roomData.govtIds[0] || '' : '';
          
          // Tenant 2 Basic details
          document.getElementById("moveInDate2").value = roomData.moveInDate2 || roomData.moveInDate || '';
          document.getElementById("rentStatus2").value = roomData.rentStatus2 || roomData.rentStatus || 'Pending';
          document.getElementById("lastPaidDate2").value = roomData.lastPaidDate2 || roomData.lastPaidDate || roomData.moveInDate || '';
          
          // Tenant 2 Financial details
          document.getElementById("rentAmount2").value = roomData.rentAmount2 || roomData.rentAmount || roomData.rent_due || '';
          document.getElementById("foodCharges2").value = roomData.foodCharges2 || roomData.foodCharges || '';
          document.getElementById("electricityCharges2").value = roomData.electricityCharges2 || roomData.electricityCharges || '';
          
          // Tenant 2 Personal details
          document.getElementById("tenantName2").value = roomData.tenants && roomData.tenants.length > 1 ? roomData.tenants[1] || '' : '';
          document.getElementById("tenantGender2").value = roomData.gender2 || 'M';
          document.getElementById("tenantContact2").value = roomData.contactNumbers && roomData.contactNumbers.length > 1 ? roomData.contactNumbers[1] || '' : '';
          document.getElementById("tenantGovtId2").value = roomData.govtIds && roomData.govtIds.length > 1 ? roomData.govtIds[1] || '' : '';
        } else {
          // Reset the form if no data exists
          resetForm();
        }
      }).catch(err => {
        console.error("Error loading room details:", err);
        showPopup("Error loading room details: " + err.message, "error");
      });
    }

    // Reset form fields
    function resetForm() {
      // Tenant 1
      document.getElementById("moveInDate1").value = '';
      document.getElementById("rentStatus1").value = 'Pending';
      document.getElementById("lastPaidDate1").value = '';
      document.getElementById("rentAmount1").value = '';
      document.getElementById("foodCharges1").value = '';
      document.getElementById("electricityCharges1").value = '';
      document.getElementById("tenantName1").value = '';
      document.getElementById("tenantGender1").value = 'M';
      document.getElementById("tenantContact1").value = '';
      document.getElementById("tenantGovtId1").value = '';
      
      // Tenant 2
      document.getElementById("moveInDate2").value = '';
      document.getElementById("rentStatus2").value = 'Pending';
      document.getElementById("lastPaidDate2").value = '';
      document.getElementById("rentAmount2").value = '';
      document.getElementById("foodCharges2").value = '';
      document.getElementById("electricityCharges2").value = '';
      document.getElementById("tenantName2").value = '';
      document.getElementById("tenantGender2").value = 'M';
      document.getElementById("tenantContact2").value = '';
      document.getElementById("tenantGovtId2").value = '';
    }

    // Get form data for saving to Firebase
    function getFormData() {
      const roomData = {
        // Tenant 1 data
        moveInDate1: document.getElementById("moveInDate1").value,
        rentStatus1: document.getElementById("rentStatus1").value,
        lastPaidDate1: document.getElementById("lastPaidDate1").value || document.getElementById("moveInDate1").value,
        rentAmount1: parseFloat(document.getElementById("rentAmount1").value) || 0,
        foodCharges1: parseFloat(document.getElementById("foodCharges1").value) || 0,
        electricityCharges1: parseFloat(document.getElementById("electricityCharges1").value) || 0,
        
        // Tenant 2 data
        moveInDate2: document.getElementById("moveInDate2").value,
        rentStatus2: document.getElementById("rentStatus2").value,
        lastPaidDate2: document.getElementById("lastPaidDate2").value || document.getElementById("moveInDate2").value,
        rentAmount2: parseFloat(document.getElementById("rentAmount2").value) || 0,
        foodCharges2: parseFloat(document.getElementById("foodCharges2").value) || 0,
        electricityCharges2: parseFloat(document.getElementById("electricityCharges2").value) || 0,
        
        // For backward compatibility and room status
        moveInDate: document.getElementById("moveInDate1").value,
        rentStatus: document.getElementById("rentStatus1").value,
        lastPaidDate: document.getElementById("lastPaidDate1").value || document.getElementById("moveInDate1").value,
        
        // Tenant details arrays
        tenants: [
          document.getElementById("tenantName1").value,
          document.getElementById("tenantName2").value
        ].filter(val => val && val.trim() !== ""),
        
        contactNumbers: [
          document.getElementById("tenantContact1").value,
          document.getElementById("tenantContact2").value
        ].filter(val => val && val.trim() !== ""),
        
        govtIds: [
          document.getElementById("tenantGovtId1").value,
          document.getElementById("tenantGovtId2").value
        ].filter(val => val && val.trim() !== "")
      };
      
      // Calculate total charges for each tenant
      roomData.totalCharges1 = roomData.rentAmount1 + roomData.foodCharges1 + roomData.electricityCharges1;
      roomData.totalCharges2 = roomData.rentAmount2 + roomData.foodCharges2 + roomData.electricityCharges2;
      
      // Total charges for the room (for backward compatibility)
      roomData.totalCharges = roomData.totalCharges1 + roomData.totalCharges2;
      
      // Add gender information
      roomData.gender1 = document.getElementById("tenantGender1").value;
      roomData.gender2 = document.getElementById("tenantGender2").value;
      
      // For backward compatibility
      roomData.gender = document.getElementById("tenantGender1").value;
      
      // Determine occupancy status
      const tenant2Name = document.getElementById("tenantName2").value.trim();
      roomData.occupancyStatus = tenant2Name ? "Fully Occupied" : "Partially Occupied";
      
      return roomData;
    }

    // Update revenue data in Firebase
    async function updateRevenueData(roomNumber, roomData, isNewAllocation = false, isVacating = false) {
      try {
        // Get current revenue data
        const revenueRef = ref(database, 'revenue');
        const revenueSnapshot = await get(revenueRef);
        const revenueData = revenueSnapshot.exists() ? revenueSnapshot.val() : {};
        
        // Get current monthly collected data
        const monthlyRef = ref(database, 'monthlyCollected');
        const monthlySnapshot = await get(monthlyRef);
        const monthlyData = monthlySnapshot.exists() ? monthlySnapshot.val() : {};
        
        // Get current total revenue
        const totalRevenueRef = ref(database, 'totalRevenue');
        const totalRevenueSnapshot = await get(totalRevenueRef);
        const totalRevenue = totalRevenueSnapshot.exists() ? totalRevenueSnapshot.val() : 0;
        
        // Current date for monthly tracking
        const currentDate = new Date();
        const currentMonth = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}`;
        
        if (isVacating) {
          // If vacating, we don't need to update revenue data
          return;
        }
        
        // Calculate total charges for this room
        const totalCharges = roomData.totalCharges || 0;
        
        // Update revenue data for this room
        revenueData[roomNumber] = {
          rentAmount: roomData.rentAmount1 + roomData.rentAmount2 || 0,
          foodCharges: roomData.foodCharges1 + roomData.foodCharges2 || 0,
          electricityCharges: roomData.electricityCharges1 + roomData.electricityCharges2 || 0,
          totalCharges: totalCharges,
          lastUpdated: new Date().toISOString()
        };
        
        // Update monthly collected data
        if (!monthlyData[currentMonth]) {
          monthlyData[currentMonth] = 0;
        }
        
        // If this is a new allocation or rent status changed to "Paid", add to monthly collected
        if (isNewAllocation) {
          if (roomData.rentStatus1 === "Paid") {
            monthlyData[currentMonth] += roomData.totalCharges1;
          }
          if (roomData.rentStatus2 === "Paid" && roomData.tenants.length > 1) {
            monthlyData[currentMonth] += roomData.totalCharges2;
          }
        }
        
        // Update total revenue if this is a new paid allocation
        let newTotalRevenue = totalRevenue;
        if (isNewAllocation) {
          if (roomData.rentStatus1 === "Paid") {
            newTotalRevenue += roomData.totalCharges1;
          }
          if (roomData.rentStatus2 === "Paid" && roomData.tenants.length > 1) {
            newTotalRevenue += roomData.totalCharges2;
          }
        }
        
        // Save all updates to Firebase
        await update(ref(database), {
          'revenue': revenueData,
          'monthlyCollected': monthlyData,
          'totalRevenue': newTotalRevenue
        });
        
      } catch (error) {
        console.error("Error updating revenue data:", error);
        showPopup("Error updating revenue data: " + error.message, "error");
      }
    }

    // Allocate Room Function
    async function allocateRoom() {
      const roomNumber = document.getElementById("selectedRoom").value;
      if (!roomNumber) {
        showPopup("Please select a room first.", "error");
        return;
      }

      const roomData = getFormData();
      const roomRef = ref(database, 'rooms/' + roomNumber);
      
      try {
        // Check if this is a new allocation
        const roomSnapshot = await get(roomRef);
        const isNewAllocation = !roomSnapshot.exists();
        
        // Save room details in Firebase
        await set(roomRef, roomData);
        
        // Update revenue data
        await updateRevenueData(roomNumber, roomData, isNewAllocation);
        
        showPopup("Room allocated successfully!", "success");
        resetForm();
      } catch (error) {
        showPopup("Error allocating room: " + error.message, "error");
      }
    }

    // Update Tenant 1 Function
    async function updateTenant1() {
      const roomNumber = document.getElementById("selectedRoom").value;
      if (!roomNumber) {
        showPopup("Please select a room first.", "error");
        return;
      }

      const roomRef = ref(database, 'rooms/' + roomNumber);
      
      try {
        // Get current data first
        const snapshot = await get(roomRef);
        
        if (snapshot.exists()) {
          const currentData = snapshot.val();
          
          // Update tenant 1 details
          const updates = {
            // Basic details
            moveInDate1: document.getElementById("moveInDate1").value,
            rentStatus1: document.getElementById("rentStatus1").value,
            lastPaidDate1: document.getElementById("lastPaidDate1").value || document.getElementById("moveInDate1").value,
            
            // Financial details
            rentAmount1: parseFloat(document.getElementById("rentAmount1").value) || 0,
            foodCharges1: parseFloat(document.getElementById("foodCharges1").value) || 0,
            electricityCharges1: parseFloat(document.getElementById("electricityCharges1").value) || 0,
            totalCharges1: parseFloat(document.getElementById("rentAmount1").value) + 
                          parseFloat(document.getElementById("foodCharges1").value) + 
                          parseFloat(document.getElementById("electricityCharges1").value) || 0,
            
            // For backward compatibility
            moveInDate: document.getElementById("moveInDate1").value,
            rentStatus: document.getElementById("rentStatus1").value,
            lastPaidDate: document.getElementById("lastPaidDate1").value || document.getElementById("moveInDate1").value,
            
            // Tenant arrays
            tenants: currentData.tenants || [],
            contactNumbers: currentData.contactNumbers || [],
            govtIds: currentData.govtIds || [],
            
            // Gender
            gender1: document.getElementById("tenantGender1").value,
            gender: document.getElementById("tenantGender1").value
          };
          
          // Update tenant 1 details in arrays
          updates.tenants[0] = document.getElementById("tenantName1").value;
          updates.contactNumbers[0] = document.getElementById("tenantContact1").value;
          updates.govtIds[0] = document.getElementById("tenantGovtId1").value;
          
          // Update in Firebase
          await update(roomRef, updates);
          showPopup("Tenant 1 details updated successfully!", "success");
        } else {
          showPopup("No data found for this room. Please allocate first.", "error");
        }
      } catch (error) {
        showPopup("Error updating tenant details: " + error.message, "error");
      }
    }

    // Update Tenant 2 Function
    async function updateTenant2() {
      const roomNumber = document.getElementById("selectedRoom").value;
      if (!roomNumber) {
        showPopup("Please select a room first.", "error");
        return;
      }

      const roomRef = ref(database, 'rooms/' + roomNumber);
      
      try {
        // Get current data first
        const snapshot = await get(roomRef);
        
        if (snapshot.exists()) {
          const currentData = snapshot.val();
          
          // Update tenant 2 details
          const updates = {
            // Basic details
            moveInDate2: document.getElementById("moveInDate2").value,
            rentStatus2: document.getElementById("rentStatus2").value,
            lastPaidDate2: document.getElementById("lastPaidDate2").value || document.getElementById("moveInDate2").value,
            
            // Financial details
            rentAmount2: parseFloat(document.getElementById("rentAmount2").value) || 0,
            foodCharges2: parseFloat(document.getElementById("foodCharges2").value) || 0,
            electricityCharges2: parseFloat(document.getElementById("electricityCharges2").value) || 0,
            totalCharges2: parseFloat(document.getElementById("rentAmount2").value) + 
                          parseFloat(document.getElementById("foodCharges2").value) + 
                          parseFloat(document.getElementById("electricityCharges2").value) || 0,
            
            // Tenant arrays
            tenants: currentData.tenants || [],
            contactNumbers: currentData.contactNumbers || [],
            govtIds: currentData.govtIds || [],
            
            // Gender
            gender2: document.getElementById("tenantGender2").value
          };
          
          // Update tenant 2 details in arrays
          updates.tenants[1] = document.getElementById("tenantName2").value;
          updates.contactNumbers[1] = document.getElementById("tenantContact2").value;
          updates.govtIds[1] = document.getElementById("tenantGovtId2").value;
          
          // Update occupancy status
          if (updates.tenants[1] && updates.tenants[1].trim() !== "") {
            updates.occupancyStatus = "Fully Occupied";
          } else {
            updates.occupancyStatus = "Partially Occupied";
          }
          
          // Update in Firebase
          await update(roomRef, updates);
          showPopup("Tenant 2 details updated successfully!", "success");
        } else {
          showPopup("No data found for this room. Please allocate first.", "error");
        }
      } catch (error) {
        showPopup("Error updating tenant details: " + error.message, "error");
      }
    }

    // Vacant Button Functionality
    async function vacateRoom() {
      const roomNumber = document.getElementById("selectedRoom").value;
      if (!roomNumber) {
        showPopup("Please select a room first.", "error");
        return;
      }

      const roomRef = ref(database, 'rooms/' + roomNumber);
      
      try {
        // Get room data before removing
        const snapshot = await get(roomRef);
        if (snapshot.exists()) {
          const roomData = snapshot.val();
          
          // Remove room from rooms collection
          await remove(roomRef);
          
          // Update revenue data to reflect the vacancy
          await updateRevenueData(roomNumber, roomData, false, true);
          
          showPopup("Room vacated successfully!", "success");
          resetForm();
        } else {
          showPopup("Room is already vacant.", "info");
        }
      } catch (error) {
        showPopup("Error vacating room: " + error.message, "error");
      }
    }

    // Add event listeners for tenant 1 buttons
    document.getElementById("updateButton1").addEventListener("click", updateTenant1);
    document.getElementById("allocateButton1").addEventListener("click", allocateRoom);
    document.getElementById("vacantButton1").addEventListener("click", vacateRoom);

    // Add event listeners for tenant 2 buttons
    document.getElementById("updateButton2").addEventListener("click", updateTenant2);
    document.getElementById("allocateButton2").addEventListener("click", allocateRoom);
    document.getElementById("vacantButton2").addEventListener("click", vacateRoom);

    // Initialize room grid on page load
    generateRoomGrid();
  </script>
</body>
</html>
